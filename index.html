<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Survey123 + JS (Public) â€” robust polling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body,#formDiv { height:100%; margin:0 }
    .note { position:fixed; left:10px; bottom:10px; background:#0008; color:#fff; padding:6px 8px; border-radius:6px; font:12px/1.3 system-ui,Segoe UI,Arial }
  </style>
  <script src="https://survey123.arcgis.com/api/jsapi/"></script>
</head>
<body>
  <div id="formDiv"></div>
  <div class="note">Form: d431107105334b68ab800f53bbcb6167 | mode: polling</div>
  <script>
    // --- Config ---
    const CLIENT_ID    = "X7mPIkcqsIiFgQfP";
    const ITEM_ID      = "d431107105334b68ab800f53bbcb6167";
    const BOUNDARY_URL = "https://services4.arcgis.com/9lICIlhSEuRFezSF/arcgis/rest/services/nsdin4515/FeatureServer/0";

    // Match your XLS 'name' exactly:
    const FIELD_LOCATION = "your_location";      // <-- geopoint name
    const FIELD_LON      = "longitude";
    const FIELD_LAT      = "latitude";
    const FIELD_INSIDE   = "inside_boundary";

    const webform = new Survey123WebForm({
      clientId:  CLIENT_ID,
      container: "formDiv",
      itemId:    ITEM_ID
    });

    async function isPointInside(x, y) {
      const params = new URLSearchParams({
        f: "json",
        where: "1=1",
        outFields: "OBJECTID",
        geometry: JSON.stringify({ x, y, spatialReference: { wkid: 4326 } }),
        geometryType: "esriGeometryPoint",
        inSR: 4326,
        spatialRel: "esriSpatialRelWithin",
        returnGeometry: "false"
      });
      const resp = await fetch(`${BOUNDARY_URL}/query?${params.toString()}`);
      if (!resp.ok) throw new Error("Boundary query failed: " + resp.status);
      const json = await resp.json();
      return Array.isArray(json.features) && json.features.length > 0;
    }

    // Write lon/lat + inside to the form
    async function writeFromLoc(pt) {
      if (!pt || pt.x == null || pt.y == null) return;
      webform.setQuestionValue({ [FIELD_LON]: pt.x, [FIELD_LAT]: pt.y });
      try {
        const inside = await isPointInside(pt.x, pt.y);
        webform.setQuestionValue({ [FIELD_INSIDE]: inside ? "YES" : "NO" });
      } catch (err) {
        console.error(err);
        webform.setQuestionValue({ [FIELD_INSIDE]: "UNKNOWN" });
      }
    }

    // 1) Preferred: fire on question change
    webform.on("questionValueChanged", (e) => {
      if (e?.question?.name === FIELD_LOCATION) {
        writeFromLoc(e.value);
      }
    });

    // 2) Robust fallback: poll the value periodically
    let last = null;
    function different(a, b) {
      return !a || !b || a.x !== b.x || a.y !== b.y;
    }

    let pollId = null;
    webform.on("formLoaded", async () => {
      // initial sync if any
      try {
        const all = await webform.getQuestionValue();
        const loc = all?.[FIELD_LOCATION];
        if (loc) { last = {x: loc.x, y: loc.y}; await writeFromLoc(loc); }
      } catch (_) { /* ignore */ }

      // start polling (every 400ms)
      pollId = setInterval(async () => {
        try {
          const all = await webform.getQuestionValue();
          const loc = all?.[FIELD_LOCATION];
          if (loc && different(loc, last)) {
            last = {x: loc.x, y: loc.y};
            await writeFromLoc(loc);
          }
        } catch (err) { /* ignore transient */ }
      }, 400);
    });

    window.addEventListener("beforeunload", () => pollId && clearInterval(pollId));
  </script>
</body>
</html>
